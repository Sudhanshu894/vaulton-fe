<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passkey Smart Account</title>
    <script src="https://unpkg.com/@simplewebauthn/browser@10.0.0/dist/bundle/index.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #00d4ff;
            margin-bottom: 16px;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #a0a0a0;
            font-size: 0.9rem;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.95rem;
        }

        input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #00d4ff;
            border: 1px solid #00d4ff;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #cc3344);
            color: #fff;
        }

        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .status.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        .status.error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            color: #ff4757;
        }

        .status.info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: #00d4ff;
        }

        .hidden {
            display: none;
        }

        .user-badge {
            background: rgba(0, 212, 255, 0.2);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-badge .address {
            font-family: monospace;
            font-size: 0.8rem;
            color: #00ff88;
            word-break: break-all;
        }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            color: #666;
        }

        .step.active {
            background: #00d4ff;
            color: #000;
        }

        .step.done {
            background: #00ff88;
            color: #000;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Passkey Smart Account</h1>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
        </div>

        <!-- Step 1: Passkey Auth -->
        <div id="authSection" class="card">
            <h2>Step 1: Authenticate with Passkey</h2>
            <p style="color: #a0a0a0; margin-bottom: 20px;">
                Register a new passkey or login with existing one.
            </p>
            <button onclick="registerPasskey()" class="btn-primary" id="registerBtn">Register New Passkey</button>
            <button onclick="loginPasskey()" class="btn-secondary" id="loginBtn">Login with Existing Passkey</button>
            <div id="authStatus" class="status hidden"></div>
        </div>

        <!-- User Info (shown after auth) -->
        <div id="userSection" class="card hidden">
            <div class="user-badge">
                <div style="font-size: 1.2rem; margin-bottom: 8px;">Authenticated</div>
                <div>User: <span id="userId" style="color: #00d4ff;"></span></div>
                <div id="smartAccountInfo" class="hidden" style="margin-top: 10px;">
                    Smart Account: <span id="smartAccountAddress" class="address"></span>
                </div>
            </div>
            <button onclick="logout()" class="btn-secondary">Logout</button>
        </div>

        <!-- Step 2: Deploy Smart Account (shown after auth, if no account) -->
        <div id="deploySection" class="card hidden">
            <h2>Step 2: Deploy Your Smart Account</h2>
            <p style="color: #a0a0a0; margin-bottom: 20px;">
                Deploy a smart account contract secured by your passkey.
            </p>
            <button onclick="deploySmartAccount()" class="btn-primary" id="deployBtn">Deploy Smart Account</button>
            <div id="deployStatus" class="status hidden"></div>
        </div>

        <!-- Step 3: Use Smart Account (shown after deploy) -->
        <div id="useSection" class="card hidden">
            <h2>Step 3: Transfer USDC</h2>
            <p style="color: #a0a0a0; margin-bottom: 20px;">
                Transfer USDC from your smart account using passkey signature.
            </p>
            <div class="form-group">
                <label>Recipient Address</label>
                <input type="text" id="recipient" placeholder="GXXX... or CXXX...">
            </div>
            <div class="form-group">
                <label>Amount (stroops, 1 USDC = 10000000)</label>
                <input type="number" id="amount" value="10000000">
            </div>
            <button onclick="transferUsdc()" class="btn-danger">Sign & Transfer</button>
            <div id="transferStatus" class="status hidden"></div>

            <div class="divider"></div>

            <h2>Contract Info</h2>
            <button onclick="getBalance()" class="btn-secondary" style="margin-bottom: 10px;">Get USDC Balance</button>
            <button onclick="getNonce()" class="btn-secondary" style="margin-bottom: 10px;">Get Nonce</button>
            <button onclick="getContractPubkey()" class="btn-secondary">Get Stored Pubkey</button>
            <div id="infoStatus" class="status hidden"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const FACTORY_ID = 'CCUNXH24APBGZ2GB4QWDQR3DSSYH5GVZ26OCJGPBYF4ZABPUMVVINOGN';
        const WASM_HASH = '45a5831c2e69e2145d05c0af74186e3b7edfc8ec72f8ff4e0f5f86d68adfde56';

        // State
        let currentUser = null;
        let credentialId = null;
        let passkeyPubkey = null;
        let smartAccountId = null;

        // Load state
        function loadState() {
            const saved = sessionStorage.getItem('passkeySmartAccount');
            if (saved) {
                const state = JSON.parse(saved);
                currentUser = state.currentUser;
                credentialId = state.credentialId;
                passkeyPubkey = state.passkeyPubkey;
                smartAccountId = state.smartAccountId;
                updateUI();
            }
        }

        // Save state
        function saveState() {
            sessionStorage.setItem('passkeySmartAccount', JSON.stringify({
                currentUser, credentialId, passkeyPubkey, smartAccountId
            }));
        }

        // Update UI based on state
        function updateUI() {
            const authSection = document.getElementById('authSection');
            const userSection = document.getElementById('userSection');
            const deploySection = document.getElementById('deploySection');
            const useSection = document.getElementById('useSection');
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');

            if (!currentUser) {
                // Not authenticated
                authSection.classList.remove('hidden');
                userSection.classList.add('hidden');
                deploySection.classList.add('hidden');
                useSection.classList.add('hidden');
                step1.className = 'step active';
                step2.className = 'step';
                step3.className = 'step';
            } else if (!smartAccountId) {
                // Authenticated but no smart account
                authSection.classList.add('hidden');
                userSection.classList.remove('hidden');
                deploySection.classList.remove('hidden');
                useSection.classList.add('hidden');
                document.getElementById('userId').textContent = currentUser;
                document.getElementById('smartAccountInfo').classList.add('hidden');
                step1.className = 'step done';
                step2.className = 'step active';
                step3.className = 'step';
            } else {
                // Has smart account
                authSection.classList.add('hidden');
                userSection.classList.remove('hidden');
                deploySection.classList.add('hidden');
                useSection.classList.remove('hidden');
                document.getElementById('userId').textContent = currentUser;
                document.getElementById('smartAccountInfo').classList.remove('hidden');
                document.getElementById('smartAccountAddress').textContent = smartAccountId;
                step1.className = 'step done';
                step2.className = 'step done';
                step3.className = 'step active';
            }
        }

        function showStatus(id, msg, type) {
            const el = document.getElementById(id);
            el.classList.remove('hidden', 'success', 'error', 'info');
            el.classList.add(type);
            el.textContent = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
        }

        function logout() {
            currentUser = null;
            credentialId = null;
            passkeyPubkey = null;
            smartAccountId = null;
            sessionStorage.removeItem('passkeySmartAccount');
            updateUI();
        }

        // Register passkey
        async function registerPasskey() {
            try {
                showStatus('authStatus', 'Starting registration...', 'info');
                document.getElementById('registerBtn').disabled = true;

                const optionsRes = await fetch(`${API_URL}/register-challenge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await optionsRes.json();
                console.log('Register challenge response:', data);

                if (!data.options) {
                    throw new Error('Invalid response from server: ' + JSON.stringify(data));
                }

                // Save tempUserId if provided
                if (data.tempUserId) {
                    sessionStorage.setItem('tempUserId', data.tempUserId);
                }

                console.log('Starting WebAuthn registration with options:', data.options);
                showStatus('authStatus', 'Please authenticate with your device...', 'info');

                const credential = await SimpleWebAuthnBrowser.startRegistration(data.options);
                console.log('Registration credential received:', credential);

                // Retrieve tempUserId
                const tempUserId = sessionStorage.getItem('tempUserId');

                const verifyRes = await fetch(`${API_URL}/register-verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cred: credential, tempUserId }),
                });
                const result = await verifyRes.json();

                if (result.verified) {
                    // Remove tempUserId on success
                    sessionStorage.removeItem('tempUserId');

                    currentUser = result.userId;
                    credentialId = credential.id;

                    // Extract pubkey
                    if (credential.response.getPublicKey) {
                        const pubKeyBuffer = credential.response.getPublicKey();
                        if (pubKeyBuffer) {
                            const pubKey = new Uint8Array(pubKeyBuffer);
                            if (pubKey.length >= 65) {
                                const rawKey = pubKey.slice(-65);
                                passkeyPubkey = btoa(String.fromCharCode(...rawKey));
                            }
                        }
                    }

                    // Check if user already has a smart account from server
                    await checkExistingSmartAccount();

                    saveState();
                    updateUI();
                    showStatus('authStatus', 'Registration successful!', 'success');
                } else {
                    showStatus('authStatus', `Registration failed: ${result.error}`, 'error');
                }
            } catch (err) {
                showStatus('authStatus', `Error: ${err.message}`, 'error');
            } finally {
                document.getElementById('registerBtn').disabled = false;
            }
        }

        // Login with passkey
        async function loginPasskey() {
            try {
                showStatus('authStatus', 'Starting login...', 'info');
                document.getElementById('loginBtn').disabled = true;

                const optionsRes = await fetch(`${API_URL}/login-challenge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await optionsRes.json();

                if (!data.options) {
                    throw new Error('Invalid response from server: ' + JSON.stringify(data));
                }

                showStatus('authStatus', 'Please authenticate...', 'info');
                const credential = await SimpleWebAuthnBrowser.startAuthentication(data.options);

                const verifyRes = await fetch(`${API_URL}/login-verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cred: credential, challengeId: data.challengeId }),
                });
                const result = await verifyRes.json();

                if (result.success) {
                    currentUser = result.userId;
                    credentialId = credential.id;

                    // Check if user has smart account
                    await checkExistingSmartAccount();

                    saveState();
                    updateUI();
                    showStatus('authStatus', 'Login successful!', 'success');
                } else {
                    showStatus('authStatus', `Login failed: ${result.error}`, 'error');
                }
            } catch (err) {
                showStatus('authStatus', `Error: ${err.message}`, 'error');
            } finally {
                document.getElementById('loginBtn').disabled = false;
            }
        }

        // Check if user already has a smart account
        async function checkExistingSmartAccount() {
            try {
                const res = await fetch(`${API_URL}/user-info?userId=${currentUser}`);
                const data = await res.json();
                if (data.smartAccountId) {
                    smartAccountId = data.smartAccountId;
                }
                if (data.passkeyPubkey && !passkeyPubkey) {
                    passkeyPubkey = data.passkeyPubkey;
                }
            } catch (e) {
                console.log('Could not fetch user info:', e);
            }
        }

        // Deploy smart account
        async function deploySmartAccount() {
            try {
                if (!currentUser || !credentialId) {
                    showStatus('deployStatus', 'Please authenticate first', 'error');
                    return;
                }

                // Need passkey pubkey for constructor
                let data = null;
                if (!passkeyPubkey) {
                    showStatus('deployStatus', 'Re-authenticating to get pubkey...', 'info');

                    const optionsRes = await fetch(`${API_URL}/login-challenge`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    data = await optionsRes.json();

                    if (!data.options) {
                        throw new Error('Invalid response from server');
                    }

                    console.log('login-challenge', data.options);

                    const credential = await SimpleWebAuthnBrowser.startAuthentication(data.options);

                    if (credential.response.getPublicKey) {
                        const pubKeyBuffer = credential.response.getPublicKey();
                        if (pubKeyBuffer) {
                            const pubKey = new Uint8Array(pubKeyBuffer);
                            if (pubKey.length >= 65) {
                                passkeyPubkey = btoa(String.fromCharCode(...pubKey.slice(-65)));
                            }
                        }
                    }
                }

                if (!passkeyPubkey) {
                    showStatus('deployStatus', 'Could not get passkey pubkey', 'error');
                    return;
                }

                showStatus('deployStatus', 'Deploying smart account...', 'info');
                document.getElementById('deployBtn').disabled = true;

                const res = await fetch(`${API_URL}/deploy-child`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        factoryId: FACTORY_ID,
                        wasmHash: WASM_HASH,
                        keyId: credentialId,
                        passkeyPubkey: passkeyPubkey,
                        userId: currentUser
                    }),
                });
                const result = await res.json();

                if (result.childId) {
                    smartAccountId = result.childId;
                    saveState();
                    updateUI();
                    showStatus('deployStatus', `Smart Account deployed!\n${result.childId}`, 'success');
                } else if (result.existingChildId) {
                    smartAccountId = result.existingChildId;
                    saveState();
                    updateUI();
                    showStatus('deployStatus', `Using existing Smart Account:\n${result.existingChildId}`, 'info');
                } else {
                    showStatus('deployStatus', `Deploy failed: ${JSON.stringify(result)}`, 'error');
                }
            } catch (err) {
                showStatus('deployStatus', `Error: ${err.message}`, 'error');
            } finally {
                document.getElementById('deployBtn').disabled = false;
            }
        }

        // Get USDC balance
        async function getBalance() {
            try {
                if (!smartAccountId) return;
                showStatus('infoStatus', 'Fetching USDC balance...', 'info');
                const res = await fetch(`${API_URL}/get-usdc-balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childId: smartAccountId }),
                });
                const result = await res.json();
                if (result.error) {
                    showStatus('infoStatus', `Error: ${result.error}`, 'error');
                } else {
                    showStatus('infoStatus', `USDC Balance: ${result.balanceInUsdc} USDC\n(${result.balanceInStroops} stroops)`, 'success');
                }
            } catch (err) {
                showStatus('infoStatus', `Error: ${err.message}`, 'error');
            }
        }

        // Get nonce
        async function getNonce() {
            try {
                if (!smartAccountId) return;
                showStatus('infoStatus', 'Fetching nonce...', 'info');
                const res = await fetch(`${API_URL}/get-nonce`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childId: smartAccountId }),
                });
                const result = await res.json();
                showStatus('infoStatus', `Nonce: ${result.nonce}`, result.error ? 'error' : 'success');
            } catch (err) {
                showStatus('infoStatus', `Error: ${err.message}`, 'error');
            }
        }

        // Get contract pubkey
        async function getContractPubkey() {
            try {
                if (!smartAccountId) return;
                showStatus('infoStatus', 'Fetching pubkey...', 'info');
                const res = await fetch(`${API_URL}/get-contract-pubkey`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childId: smartAccountId }),
                });
                const result = await res.json();
                showStatus('infoStatus', `Pubkey (${result.length} bytes):\n${result.pubkey}`, result.error ? 'error' : 'success');
            } catch (err) {
                showStatus('infoStatus', `Error: ${err.message}`, 'error');
            }
        }

        // Transfer USDC
        async function transferUsdc() {
            try {
                const recipient = document.getElementById('recipient').value;
                const amount = document.getElementById('amount').value;
                console.log(`smartAccountId: ${smartAccountId}`);
                if (!smartAccountId || !recipient || !amount) {
                    showStatus('transferStatus', 'All fields required', 'error');
                    return;
                }

                showStatus('transferStatus', 'Getting nonce...', 'info');
                const nonceRes = await fetch(`${API_URL}/get-nonce`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childId: smartAccountId }),
                });
                const { nonce } = await nonceRes.json();

                // Build challenge
                const amountBigInt = BigInt(amount);
                const amountBytes = new Uint8Array(16);
                for (let i = 0; i < 16; i++) amountBytes[i] = Number((amountBigInt >> BigInt(i * 8)) & 0xffn);

                const nonceBigInt = BigInt(nonce);
                const nonceBytes = new Uint8Array(8);
                for (let i = 0; i < 8; i++) nonceBytes[i] = Number((nonceBigInt >> BigInt(i * 8)) & 0xffn);

                const functionName = new TextEncoder().encode('transfer_usdc');
                const challengeData = new Uint8Array(functionName.length + 16 + 8);
                challengeData.set(functionName, 0);
                challengeData.set(amountBytes, functionName.length);
                challengeData.set(nonceBytes, functionName.length + 16);

                const challengeHash = await crypto.subtle.digest('SHA-256', challengeData);
                const challenge = btoa(String.fromCharCode(...new Uint8Array(challengeHash)))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

                showStatus('transferStatus', 'Please sign with passkey...', 'info');

                const optionsRes = await fetch(`${API_URL}/login-challenge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await optionsRes.json();

                if (!data.options) {
                    throw new Error('Invalid response from server');
                }

                data.options.challenge = challenge;

                const credential = await SimpleWebAuthnBrowser.startAuthentication(data.options);

                const sigBytes = base64UrlToBytes(credential.response.signature);
                const rsSignature = derToRs(sigBytes);
                const signatureHex = bytesToHex(rsSignature);

                showStatus('transferStatus', 'Submitting transfer...', 'info');

                const res = await fetch(`${API_URL}/transfer-usdc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        childId: smartAccountId,
                        recipient,
                        amount,
                        signatureHex,
                        authData: credential.response.authenticatorData,
                        clientDataJSON: credential.response.clientDataJSON,
                    }),
                });
                const result = await res.json();

                if (result.status === 'SUCCESS') {
                    showStatus('transferStatus', `Transfer successful!\nTx: ${result.txHash}`, 'success');
                } else {
                    showStatus('transferStatus', `Result: ${JSON.stringify(result, null, 2)}`, result.error ? 'error' : 'info');
                }
            } catch (err) {
                showStatus('transferStatus', `Error: ${err.message}`, 'error');
            }
        }

        function base64UrlToBytes(b64) {
            const base64 = b64.replace(/-/g, '+').replace(/_/g, '/');
            const padded = base64 + '='.repeat((4 - base64.length % 4) % 4);
            return new Uint8Array([...atob(padded)].map(c => c.charCodeAt(0)));
        }

        function bytesToHex(bytes) {
            return [...bytes].map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function derToRs(der) {
            let offset = 2;
            if (der[offset++] !== 0x02) throw new Error('Invalid DER');
            let rLen = der[offset++];
            let r = der.slice(offset, offset + rLen);
            offset += rLen;
            if (r[0] === 0 && r.length > 32) r = r.slice(1);
            while (r.length < 32) r = new Uint8Array([0, ...r]);
            r = r.slice(-32);

            if (der[offset++] !== 0x02) throw new Error('Invalid DER');
            let sLen = der[offset++];
            let s = der.slice(offset, offset + sLen);
            if (s[0] === 0 && s.length > 32) s = s.slice(1);
            while (s.length < 32) s = new Uint8Array([0, ...s]);
            s = s.slice(-32);

            // Normalize S (Low-S check for secp256r1)
            // Soroban/Stellar requires signatures to be in low-S form to prevent malleability
            // Curve order N for secp256r1 (P-256)
            const n = BigInt("0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551");
            const halfN = n / 2n;

            // Convert s buffer to BigInt
            let sBig = 0n;
            for (const byte of s) {
                sBig = (sBig << 8n) + BigInt(byte);
            }

            // If s > N/2, replace s with N - s
            if (sBig > halfN) {
                console.log('Normalizing signature s value to low-S form');
                sBig = n - sBig;
                // Convert back to 32 bytes
                for (let i = 0; i < 32; i++) {
                    s[31 - i] = Number((sBig >> (BigInt(i) * 8n)) & 0xFFn);
                }
            }

            const rs = new Uint8Array(64);
            rs.set(r, 0);
            rs.set(s, 32);
            return rs;
        }

        loadState();
    </script>
</body>

</html>